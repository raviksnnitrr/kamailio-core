####### Global Parameters #########

# External IP advertisement

advertised_address="52.66.197.207"

advertised_port=5060

# Load required modules
loadmodule "tm.so"
loadmodule "sl.so"
loadmodule "rr.so"
loadmodule "maxfwd.so"
loadmodule "usrloc.so"
loadmodule "registrar.so"
loadmodule "textops.so"
loadmodule "xlog.so"
loadmodule "dispatcher.so"
loadmodule "pv.so"        # Add this - required for pseudo-variables

# ----- Interfaces -----
listen=udp:172.31.33.161:5070     # Internal (FS nodes)
listen=udp:172.31.33.161:5060     # External (ITSPs)

# ----- Dispatcher -----
modparam("dispatcher", "list_file", "/etc/kamailio/dispatcher.list")
modparam("dispatcher", "flags", 2)

####### Routing #########

request_route {
    # Check for too many hops
    if (!mf_process_maxfwd_header("10")) {
        sl_send_reply("483","Too Many Hops");
        exit;
    }
    
    # Handle CANCEL and ACK
    if (is_method("CANCEL|ACK")) {
        t_relay();
        exit;
    }
    
    # Outbound from FS → ITSP
    if ($si=="3.6.74.101" || $si=="13.201.199.174") {
        xlog("L_INFO", "Outbound call from FS [$si] -> ITSP\n");
        route(TO_ITSP);
        exit;
    }
    
    # Inbound from ITSPs → FS
    if ($si=="voip.in1.exotel.com" || $rd=="dpdzero2m.pstn.exotel.com") {
        xlog("L_INFO", "Inbound from Exotel -> FS\n");
        route(TO_FS);
        exit;
    }
    
    if ($si=="3.111.105.195" || $rd=="3.111.105.195") {
        xlog("L_INFO", "Inbound from Airtel -> FS\n");
        route(TO_FS);
        exit;
    }
    
    if ($si=="tata.proxy.com" || $rd=="tata.pstn.com") {
        xlog("L_INFO", "Inbound from Tata -> FS\n");
        route(TO_FS);
        exit;
    }
    
    route(RELAY);
}

# ----- Routes -----

# Outbound routing: FS decides realm, Kamailio maps realm → ITSP proxy
route[TO_ITSP] {
    record_route();
    if ($ct =~ "gw=exotel-vsip") {
        xlog("L_INFO", "Routing to Exotel based on gateway parameter\n");
        $du = "sip:voip.in1.exotel.com:5070";
    } else if ($ct =~ "gw=airtel-vsip") {
        xlog("L_INFO", "Routing to Airtel based on gateway parameter\n");
        $du = "sip:3.111.105.195:5080";
    } else if ($ct =~ "gw=tata-vsip") {
        xlog("L_INFO", "Routing to Tata based on gateway parameter\n");
        $du = "sip:tata.proxy.com:5060";
    } else {
        xlog("L_ERR", "No gateway parameter found in Contact header: $ct\n");
        sl_send_reply("403","Forbidden");
        exit;
    }
    
    t_relay();
    exit;
}

# Inbound calls go to FS cluster
route[TO_FS] {
    record_route();
    
    if(!ds_select_dst("1", "4")) {
        sl_send_reply("503", "No FreeSWITCH available");
        exit;
    }
    
    xlog("L_INFO", "Dispatching inbound call to FS: $du\n");
    t_relay();
    exit;
}

route[RELAY] {
    record_route();
    t_relay();
    exit;
}
root@ip-172-31-33-161:/etc/kamailio# sudo systemctl restart freeswitch
Failed to restart freeswitch.service: Unit freeswitch.service not found.
root@ip-172-31-33-161:/etc/kamailio# sudo systemctl restart kamailio
root@ip-172-31-33-161:/etc/kamailio# cat kamailio.cfg
####### Global Parameters #########

# External IP advertisement

advertised_address="52.66.197.207"

advertised_port=5060

# Load required modules
loadmodule "tm.so"
loadmodule "sl.so"
loadmodule "rr.so"
loadmodule "maxfwd.so"
loadmodule "usrloc.so"
loadmodule "registrar.so"
loadmodule "textops.so"
loadmodule "xlog.so"
loadmodule "dispatcher.so"
loadmodule "pv.so"        # Add this - required for pseudo-variables

# ----- Interfaces -----
listen=udp:172.31.33.161:5070     # Internal (FS nodes)
listen=udp:172.31.33.161:5060     # External (ITSPs)

# ----- Dispatcher -----
modparam("dispatcher", "list_file", "/etc/kamailio/dispatcher.list")
modparam("dispatcher", "flags", 2)

####### Routing #########

request_route {
    # Check for too many hops
    if (!mf_process_maxfwd_header("10")) {
        sl_send_reply("483","Too Many Hops");
        exit;
    }
    
    # Handle CANCEL and ACK
    if (is_method("CANCEL|ACK")) {
        t_relay();
        exit;
    }
    
    # Outbound from FS → ITSP
    if ($si=="3.6.74.101" || $si=="13.201.199.174") {
        xlog("L_INFO", "Outbound call from FS [$si] -> ITSP\n");
        route(TO_ITSP);
        exit;
    }
    
    # Inbound from ITSPs → FS
    if ($si=="voip.in1.exotel.com" || $rd=="dpdzero2m.pstn.exotel.com") {
        xlog("L_INFO", "Inbound from Exotel -> FS\n");
        route(TO_FS);
        exit;
    }
    
    if ($si=="3.111.105.195" || $rd=="3.111.105.195") {
        xlog("L_INFO", "Inbound from Airtel -> FS\n");
        route(TO_FS);
        exit;
    }
    
    if ($si=="tata.proxy.com" || $rd=="tata.pstn.com") {
        xlog("L_INFO", "Inbound from Tata -> FS\n");
        route(TO_FS);
        exit;
    }
    
    route(RELAY);
}

# ----- Routes -----

# Outbound routing: FS decides realm, Kamailio maps realm → ITSP proxy
route[TO_ITSP] {
    record_route();
    if ($ct =~ "gw=exotel-vsip") {
        xlog("L_INFO", "Routing to Exotel based on gateway parameter\n");
        $du = "sip:voip.in1.exotel.com:5070";
    } else if ($ct =~ "gw=airtel-vsip") {
        xlog("L_INFO", "Routing to Airtel based on gateway parameter\n");
        $du = "sip:3.111.105.195:5080";
    } else if ($ct =~ "gw=tata-vsip") {
        xlog("L_INFO", "Routing to Tata based on gateway parameter\n");
        $du = "sip:tata.proxy.com:5060";
    } else {
        xlog("L_ERR", "No gateway parameter found in Contact header: $ct\n");
        sl_send_reply("403","Forbidden");
        exit;
    }
    
    t_relay();
    exit;
}

# Inbound calls go to FS cluster
route[TO_FS] {
    record_route();
    
    if(!ds_select_dst("1", "4")) {
        sl_send_reply("503", "No FreeSWITCH available");
        exit;
    }
    
    xlog("L_INFO", "Dispatching inbound call to FS: $du\n");
    t_relay();
    exit;
}

route[RELAY] {
    record_route();
    t_relay();
    exit;
}
